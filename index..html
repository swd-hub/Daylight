<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>出雲市の日出・日入・月出・月入・日照時間・夜間長・月齢</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>
  <style>
    .flex-area {
      display: flex;
      justify-content: flex-start;
      align-items: flex-start;
      margin-top: 2em;
      gap: 2em;
    }
    #resultTable {
      min-width: 600px;
    }
    #daylightChart {
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td { text-align: center; }
  </style>
</head>
<body>
  <h1>出雲市の日出・日入・月出・月入・日照時間・夜間長・月齢</h1>
  <label>開始日:
    <input type="date" id="start-date" value="2025-06-25">
  </label>
  <label>終了日:
    <input type="date" id="end-date" value="2025-06-29">
  </label>
  <button id="btn">取得</button>

  <br><br>

  <div class="flex-area">
    <table id="resultTable" border="1">
      <thead>
        <tr>
          <th>日付</th>
          <th>日出（JST）</th>
          <th>日没（JST）</th>
          <th>日照時間</th>
          <th>夜間長</th>
          <th>月の出（JST）</th>
          <th>月の入り（JST）</th>
          <th>月齢</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <canvas id="daylightChart" width="350" height="250"></canvas>
  </div>

  <script>
    // JSTのYYYY-MM-DDをUTCの前日15:00に変換
    function getBaseDateUTC(yyyyMMdd) {
      // JST 0時 → UTC前日15:00
      // 例: 2025-06-25T00:00:00+09:00 → 2025-06-24T15:00:00Z
      const [y, m, d] = yyyyMMdd.split('-').map(Number);
      return new Date(Date.UTC(y, m - 1, d, -9, 0, 0));
    }

    // JST時刻に変換して「HH:MM:SS」表示
    function formatTimeJST(date) {
      if (!date || isNaN(date.getTime())) return "-";
      // UTC→JST補正
      const jst = new Date(date.getTime() + 9 * 60 * 60 * 1000);
      return jst.toTimeString().slice(0,8);
    }

    // 秒→「X時間Y分Z秒」
    function formatHMS(sec) {
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = Math.floor(sec % 60);
      return `${h}時間${m}分${s}秒`;
    }

    // 月齢（日数）
    function getMoonAge(date) {
      const synodicMonth = 29.530588853;
      const phase = SunCalc.getMoonIllumination(date).phase;
      return (phase * synodicMonth).toFixed(1);
    }

    document.getElementById("btn").addEventListener("click", () => {
      const startDate = new Date(document.getElementById("start-date").value);
      const endDate = new Date(document.getElementById("end-date").value);
      const lat = 35.3667;
      const lon = 132.75;

      const tableBody = document.querySelector('#resultTable tbody');
      tableBody.innerHTML = "";
      let labels = [];
      let nightHours = [];

      for (
        let d = new Date(startDate);
        d <= endDate;
        d.setDate(d.getDate() + 1)
      ) {
        const yyyyMMdd = d.toISOString().slice(0, 10);

        // JSTの0時をUTC基準で渡す
        const baseDateUTC = getBaseDateUTC(yyyyMMdd);

        // SunCalcで天文データ
        const sunTimes = SunCalc.getTimes(baseDateUTC, lat, lon);
        const moonTimes = SunCalc.getMoonTimes(baseDateUTC, lat, lon);
        const moonAge = getMoonAge(baseDateUTC);

        // 日の出・日の入り（UTC→JST補正して表示）
        const sunrise = sunTimes.sunrise;
        const sunset  = sunTimes.sunset;

        // 日照時間・夜間長
        let daylightSec = (sunrise && sunset) ? (sunset - sunrise) / 1000 : null;
        let nightSec = (daylightSec !== null) ? 24 * 3600 - daylightSec : null;

        // 月の出・月の入り（UTC→JST補正して表示）
        const moonrise = moonTimes.rise;
        const moonset  = moonTimes.set;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${yyyyMMdd}</td>
          <td>${formatTimeJST(sunrise)}</td>
          <td>${formatTimeJST(sunset)}</td>
          <td>${daylightSec !== null ? formatHMS(daylightSec) : "-"}</td>
          <td>${nightSec !== null ? formatHMS(nightSec) : "-"}</td>
          <td>${formatTimeJST(moonrise)}</td>
          <td>${formatTimeJST(moonset)}</td>
          <td>${moonAge}</td>
        `;
        tableBody.appendChild(tr);

        labels.push(yyyyMMdd);
        nightHours.push(nightSec !== null ? (nightSec / 3600) : null);
      }

      // Chart.jsグラフ
      const ctx = document.getElementById('daylightChart').getContext('2d');
      if(window.daylightChartObj){ window.daylightChartObj.destroy(); }
      window.daylightChartObj = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '夜間長（時間）',
            data: nightHours,
            borderColor: 'blue',
            backgroundColor: 'rgba(0, 100, 255, 0.2)',
            spanGaps: true,
          }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          scales: {
            x: { title: { display: true, text: '日付' } },
            y: { title: { display: true, text: '夜間長（時間）' }, min: 0, max: 24 }
          }
        }
      });
    });
  </script>
</body>
</html>
