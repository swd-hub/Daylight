<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>出雲市の日出・日入・月出・月入・日照時間・夜間長・月齢（2API版）</title>
  <style>
    th, td { text-align: center; }
    #resultTable { min-width: 700px; }
  </style>
</head>
<body>
  <h1>出雲市の日出・日入・月出・月入・日照時間・夜間長・月齢（2API版）</h1>
  <label>開始日:
    <input type="date" id="start-date" value="2025-06-25">
  </label>
  <label>終了日:
    <input type="date" id="end-date" value="2025-06-29">
  </label>
  <button id="btn">取得</button>
  <br><br>
  <table id="resultTable" border="1">
    <thead>
      <tr>
        <th>日付</th>
        <th>日出（JST）</th>
        <th>日没（JST）</th>
        <th>日照時間</th>
        <th>夜間長</th>
        <th>月の出（JST）</th>
        <th>月の入り（JST）</th>
        <th>月齢</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    const lat = 35.3667;
    const lon = 132.75;
    const tbody = document.querySelector('#resultTable tbody');

    function pad0(n) { return n < 10 ? '0' + n : n; }

// JST変換（ISO8601 UTC → JST）
function toJSTTimeStr(dtstr) {
  if (!dtstr) return "-";
  const utc = new Date(dtstr);
  if (isNaN(utc.getTime())) return "-";
  const jst = new Date(utc.getTime() + 9 * 60 * 60 * 1000);
  return pad0(jst.getHours()) + ":" + pad0(jst.getMinutes()) + ":" + pad0(jst.getSeconds());
}

    // 日照時間・夜間長計算
    function getHMS(sec) {
      if (isNaN(sec) || sec < 0) return "-";
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = Math.floor(sec % 60);
      return `${h}時間${m}分${s}秒`;
    }

    document.getElementById("btn").onclick = async () => {
      tbody.innerHTML = '';
      const startDate = new Date(document.getElementById("start-date").value);
      const endDate = new Date(document.getElementById("end-date").value);

      for (
        let d = new Date(startDate);
        d <= endDate;
        d.setDate(d.getDate() + 1)
      ) {
        const yyyy = d.getFullYear();
        const mm = pad0(d.getMonth() + 1);
        const dd = pad0(d.getDate());
        const datestr = `${yyyy}-${mm}-${dd}`;

        // 太陽データ
        let sunriseJST = "-", sunsetJST = "-", daylightHMS = "-", nightHMS = "-";
        try {
          const resSun = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&date=${datestr}&formatted=0`);
          const dataSun = await resSun.json();
          if (dataSun.status === "OK") {
            sunriseJST = toJSTTimeStr(dataSun.results.sunrise);
            sunsetJST = toJSTTimeStr(dataSun.results.sunset);

            const riseDate = new Date(Date.parse(dataSun.results.sunrise));
            const setDate = new Date(Date.parse(dataSun.results.sunset));
            if (!isNaN(riseDate.getTime()) && !isNaN(setDate.getTime())) {
              let daylightSec = (setDate - riseDate) / 1000;
              if (daylightSec < 0) daylightSec += 24 * 3600;
              daylightHMS = getHMS(daylightSec);
              nightHMS = getHMS(24 * 3600 - daylightSec);
            }
          }
        } catch (e) {}

        // 月データ
        let moonrise = "-", moonset = "-", moonage = "-";
        try {
          const resMoon = await fetch(`https://eco.mtk.nao.ac.jp/koyomi/api/moonrise_set.php?date=${datestr}&lat=${lat}&lon=${lon}`);
          const dataMoon = await resMoon.json();
          moonrise = dataMoon.moonrise || "-";
          moonset = dataMoon.moonset  || "-";
          moonage = dataMoon.age      || "-";
        } catch (e) {}

        // 表に追加
        tbody.innerHTML += `
          <tr>
            <td>${datestr}</td>
            <td>${sunriseJST}</td>
            <td>${sunsetJST}</td>
            <td>${daylightHMS}</td>
            <td>${nightHMS}</td>
            <td>${moonrise}</td>
            <td>${moonset}</td>
            <td>${moonage}</td>
          </tr>
        `;
      }
    };
  </script>
</body>
</html>
