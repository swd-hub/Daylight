<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>出雲市の日出・日入・月出・月入・日照時間・夜間長・月齢（2API版）</title>
  <style>
    th, td { text-align: center; }
    #resultTable { min-width: 700px; }
  </style>
</head>
<body>
  <h1>出雲市の日出・日入・月出・月入・日照時間・夜間長・月齢（2API版）</h1>
  <label>開始日:
    <input type="date" id="start-date" value="2025-06-25">
  </label>
  <label>終了日:
    <input type="date" id="end-date" value="2025-06-29">
  </label>
  <button id="btn">取得</button>
  <br><br>
  <table id="resultTable" border="1">
    <thead>
      <tr>
        <th>日付</th>
        <th>日出（JST）</th>
        <th>日没（JST）</th>
        <th>日照時間</th>
        <th>夜間長</th>
        <th>月の出（JST）</th>
        <th>月の入り（JST）</th>
        <th>月齢</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    const lat = 35.3667;
    const lon = 132.75;
    const tbody = document.querySelector('#resultTable tbody');

    function pad0(n) { return n < 10 ? '0' + n : n; }

    // UTC ISO → JST に正確に変換
    function toJSTTimeStr(isoUtc) {
      if (!isoUtc) return "-";
      const d = new Date(isoUtc); // ISOに +00:00 があるのでUTCとして扱われる
      if (isNaN(d.getTime())) return "-";
      const h = d.getUTCHours() + 9;
      const jst = new Date(d.getTime() + (9 * 3600 * 1000));
      return pad0(jst.getUTCHours()) + ":" + pad0(jst.getUTCMinutes()) + ":" + pad0(jst.getUTCSeconds());
    }

    function getHMS(sec) {
      if (isNaN(sec) || sec < 0) return "-";
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = Math.floor(sec % 60);
      return `${h}時間${m}分${s}秒`;
    }

    document.getElementById("btn").onclick = async () => {
      tbody.innerHTML = '';
      const s = new Date(document.getElementById("start-date").value);
      const e = new Date(document.getElementById("end-date").value);
      for (let d = new Date(s); d <= e; d.setDate(d.getDate()+1)) {
        const Y = d.getFullYear();
        const M = pad0(d.getMonth()+1);
        const D = pad0(d.getDate());
        const ds = `${Y}-${M}-${D}`;

        let sr = "-", ss = "-", dh = "-", nh = "-";
        try {
          const r = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lon}&date=${ds}&formatted=0`);
          const j = await r.json();
          if (j.status === "OK") {
            sr = toJSTTimeStr(j.results.sunrise);
            ss = toJSTTimeStr(j.results.sunset);
            const ru = new Date(j.results.sunrise);
            const su = new Date(j.results.sunset);
            let delta = (su.getTime() - ru.getTime())/1000;
            if (delta < 0) delta += 86400;
            dh = getHMS(delta);
            nh = getHMS(86400 - delta);
          }
        } catch {}

        let mr = "-", ms = "-", ma = "-";
        try {
          const r2 = await fetch(`https://eco.mtk.nao.ac.jp/koyomi/api/moonrise_set.php?date=${ds}&lat=${lat}&lon=${lon}`);
          const j2 = await r2.json();
          mr = j2.moonrise || "-";
          ms = j2.moonset || "-";
          ma = j2.age || "-";
        } catch {}

        tbody.innerHTML += `
          <tr>
            <td>${ds}</td><td>${sr}</td><td>${ss}</td><td>${dh}</td><td>${nh}</td><td>${mr}</td><td>${ms}</td><td>${ma}</td>
          </tr>`;
      }
    };
  </script>
</body>
</html>
